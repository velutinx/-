<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Character Poll</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }

    .poll-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .poll-option {
      position: relative;
      cursor: pointer;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #333;
    }

    .poll-option img {
      width: 100%;
      display: block;
    }

    .label {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }

    .percent {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: rgba(0, 120, 255, 0.6);
      width: 0%;
      transition: width 0.5s ease;
      pointer-events: none;
    }

    .percent-text {
      position: absolute;
      top: 8px;
      right: 8px;
      font-weight: bold;
      z-index: 2;
    }

    #totalVotes {
      margin-top: 20px;
      font-size: 16px;
      opacity: 0.8;
    }
  </style>
</head>
<body>

<h2>Vote for Your Favorite Character</h2>

<div class="poll-grid" id="pollGrid"></div>
<div id="totalVotes">Votes: 0</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://didbtueftralythsnbyv.supabase.co";
  const SUPABASE_KEY = "sb_publishable_AW3xCqP3yv2zNqqlY7Hv-Q_3tCdWElq";

  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  const options = [
    { id: 1, name: "Character 1", img: "Images/Poll 1/1.jpg" },
    { id: 2, name: "Character 2", img: "Images/Poll 1/2.jpg" },
    { id: 3, name: "Character 3", img: "Images/Poll 1/3.jpg" },
    { id: 4, name: "Character 4", img: "Images/Poll 1/4.jpg" },
    { id: 5, name: "Character 5", img: "Images/Poll 1/5.jpg" },
    { id: 6, name: "Character 6", img: "Images/Poll 1/6.jpg" },
    { id: 7, name: "Character 7", img: "Images/Poll 1/7.jpg" },
    { id: 8, name: "Character 8", img: "Images/Poll 1/8.jpg" },
    { id: 9, name: "Character 9", img: "Images/Poll 1/9.jpg" },
    { id: 10, name: "Character 10", img: "Images/Poll 1/10.jpg" },
    { id: 11, name: "Character 11", img: "Images/Poll 1/11.jpg" },
    { id: 12, name: "Character 12", img: "Images/Poll 1/12.jpg" }
  ];

  function getOrCreateVoterId() {
    let id = localStorage.getItem("voter_id");
    if (!id) {
      id = crypto.randomUUID();
      localStorage.setItem("voter_id", id);
    }
    return id;
  }

  const voterId = getOrCreateVoterId();

  function renderPoll() {
    const grid = document.getElementById("pollGrid");
    grid.innerHTML = "";

    options.forEach(opt => {
      const div = document.createElement("div");
      div.className = "poll-option";
      div.innerHTML = `
        <div class="percent" id="percent-${opt.id}"></div>
        <div class="percent-text" id="percent-text-${opt.id}"></div>
        <img src="${opt.img}">
        <div class="label">${opt.name}</div>
      `;
      div.onclick = () => vote(opt.id);
      grid.appendChild(div);
    });
  }

  async function vote(optionId) {
    const { data: existing } = await db
      .from("poll_votes")
      .select("*")
      .eq("voter_id", voterId)
      .maybeSingle();

    if (existing) {
      await db
        .from("poll_votes")
        .update({ option_id: optionId })
        .eq("voter_id", voterId);
    } else {
      await db
        .from("poll_votes")
        .insert({
          option_id: optionId,
          voter_id: voterId,
          weight: 1
        });
    }

    await loadResults();
  }

  async function loadResults() {
    const { data } = await db
      .from("poll_votes")
      .select("option_id, weight");

    const totals = {};
    let totalVotes = 0;

    data.forEach(row => {
      totals[row.option_id] = (totals[row.option_id] || 0) + row.weight;
      totalVotes += row.weight;
    });

    document.getElementById("totalVotes").innerText = `Votes: ${totalVotes}`;

    options.forEach(opt => {
      const count = totals[opt.id] || 0;
      const percent = totalVotes ? Math.round((count / totalVotes) * 100) : 0;

      document.getElementById(`percent-${opt.id}`).style.width = percent + "%";
      document.getElementById(`percent-text-${opt.id}`).innerText = percent + "%";
    });
  }

  renderPoll();
  loadResults();
</script>

</body>
</html>
